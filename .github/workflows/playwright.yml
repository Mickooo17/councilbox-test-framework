name: Playwright QA Pipeline
on:
  schedule:
    - cron: '30 0 * * *' # 1:30 AM CET (00:30 UTC)
  workflow_dispatch:
    inputs:
      send_email:
        description: 'Send email notification?'
        default: true
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      GITHUB_USER: 'Mickooo17'
      GITHUB_REPO: 'councilbox-test-framework'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npx playwright test --project=chromium --reporter=line,allure-playwright
        continue-on-error: true

      - name: Extract Allure Summary
        if: always()
        run: node scripts/extract-allure-summary.js

      - name: Load Allure History
        if: always()
        continue-on-error: true
        run: |
          git checkout gh-pages
          mkdir -p allure-results/history
          cp -r builds/$(ls builds | sort -n | tail -1)/history/* allure-results/history/ || echo "No history found"
          git checkout -

      - name: Generate Allure Report
        if: always()
        run: npx allure generate allure-results --clean -o allure-report

      - name: Deploy to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./allure-report
          destination_dir: builds/${{ github.run_number }}

      - name: Read Summary Data
        if: always()
        id: vars
        run: |
          echo "TOTAL=$(cat total-tests.txt || echo '0')" >> $GITHUB_OUTPUT
          echo "PASSED=$(cat passed-tests.txt || echo '0')" >> $GITHUB_OUTPUT
          echo "FAILED=$(cat failed-tests-count.txt || echo '0')" >> $GITHUB_OUTPUT
          echo "SKIPPED=$(cat skipped-tests.txt || echo '0')" >> $GITHUB_OUTPUT
          echo "FAILED_NAME=$(cat failed-test-name.txt || echo 'N/A')" >> $GITHUB_OUTPUT
          # Postavljanje boja i statusa za email
          if [ "${{ job.status }}" = "success" ]; then
            echo "STATUS_TEXT=SUCCESS" >> $GITHUB_ENV
            echo "STATUS_COLOR=#2eae6f" >> $GITHUB_ENV
            echo "EMAIL_BG=#e6fffa" >> $GITHUB_ENV
          else
            echo "STATUS_TEXT=FAILURE" >> $GITHUB_ENV
            echo "STATUS_COLOR=#e53e3e" >> $GITHUB_ENV
            echo "EMAIL_BG=#fff5f5" >> $GITHUB_ENV
          fi

      - name: Send Results to n8n (Ngrok)
        if: always()
        run: |
          curl -X POST https://gunless-isosceles-gayle.ngrok-free.app/webhook/playwright-results \
          -H "Content-Type: application/json" \
          -d '{
              "status": "${{ job.status }}",
              "build": "${{ github.run_number }}",
              "total": "${{ steps.vars.outputs.TOTAL }}",
              "passed": "${{ steps.vars.outputs.PASSED }}",
              "failed": "${{ steps.vars.outputs.FAILED }}",
              "reportUrl": "https://${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/builds/${{ github.run_number }}/"
          }'

      - name: Send Email Notification
        if: always() && (github.event.inputs.send_email == 'true' || github.event_name == 'schedule')
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: councilboxautotest@gmail.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: Councilbox QA Report - Build #${{ github.run_number }} - ${{ env.STATUS_TEXT }}
          to: ammar.micijevic@councilbox.com, dzenan.dzakmic@councilbox.com, muhamed.adzamija@councilbox.com, almir.demirovic@councilbox.com, emiliano.ribaudo@councilbox.com
          from: Councilbox Automation
          html_body: |
            <!DOCTYPE html>
            <html>
            <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f5f7; margin: 0; padding: 20px;">
              <div style="max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                
                <!-- Header -->
                <div style="background-color: ${{ env.STATUS_COLOR }}; padding: 30px 20px; text-align: center;">
                  <h1 style="color: white; margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 1px;">${{ env.STATUS_TEXT }}</h1>
                  <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 14px;">Build #${{ github.run_number }}</p>
                </div>

                <!-- Content -->
                <div style="padding: 30px;">
                  <p style="color: #4a5568; font-size: 16px; text-align: center; margin-bottom: 25px;">
                    Automated tests have completed. Here is the summary:
                  </p>

                  <!-- Stats Grid -->
                  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <div style="text-align: center; padding: 15px; background-color: #f7fafc; border-radius: 6px;">
                      <div style="font-size: 24px; font-weight: bold; color: #2d3748;">${{ steps.vars.outputs.TOTAL }}</div>
                      <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Total</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background-color: #f0fff4; border-radius: 6px;">
                      <div style="font-size: 24px; font-weight: bold; color: #38a169;">${{ steps.vars.outputs.PASSED }}</div>
                      <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Passed</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background-color: #fff5f5; border-radius: 6px;">
                      <div style="font-size: 24px; font-weight: bold; color: #e53e3e;">${{ steps.vars.outputs.FAILED }}</div>
                      <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Failed</div>
                    </div>
                  </div>

                  <!-- Failed Test Info (if any) -->
                  <div style="background-color: ${{ env.EMAIL_BG }}; border-left: 4px solid ${{ env.STATUS_COLOR }}; padding: 15px; margin-bottom: 30px; border-radius: 4px;">
                    <p style="margin: 0; color: #4a5568;">
                      <strong>First Failed Test:</strong> <span style="font-family: monospace;">${{ steps.vars.outputs.FAILED_NAME }}</span>
                    </p>
                  </div>

                  <!-- CTA Button -->
                  <div style="text-align: center;">
                    <a href="https://${{ env.GITHUB_USER }}.github.io/${{ env.GITHUB_REPO }}/builds/${{ github.run_number }}/" 
                       style="display: inline-block; background-color: #3182ce; color: white; padding: 14px 28px; text-decoration: none; border-radius: 6px; font-weight: bold; font-size: 16px; transition: background-color 0.2s;">
                       View Full Allure Report
                    </a>
                  </div>

                </div>

                <!-- Footer -->
                <div style="background-color: #edf2f7; padding: 15px; text-align: center; font-size: 12px; color: #718096;">
                  <p style="margin: 0;">Sent by Councilbox Automation â€¢ GitHub Actions</p>
                </div>
              </div>
            </body>
            </html>